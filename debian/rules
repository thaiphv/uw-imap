#!/usr/bin/make -f
# Made with the aid of debmake, by Christoph Lameter,
# based on the sample debian/rules file for GNU hello by Ian Jackson.

export DH_COMPAT=2
DEBVERSION=$(shell head -1 debian/changelog | cut '-d ' -f 2 | sed 's/[()]//g')
VERSION=$(shell expr `pwd` : '.*-\([0-9.]*\)')

# dbs rules
TAR_DIR := imap-2001a
include /usr/share/dbs/dbs-build.mk

build: $(STAMP_DIR)/build-stamp

$(STAMP_DIR)/config-stamp: $(unpacked) $(patched)
	dh_testdir
	# nothing to do here yet
	touch $(STAMP_DIR)/config-stamp

$(STAMP_DIR)/build-stamp: $(STAMP_DIR)/config-stamp
	dh_testdir	
	$(MAKE) -C $(BUILD_TREE) VERSION=$(VERSION) lnp
	mv $(BUILD_TREE)/c-client/c-client.a .
	$(MAKE) -C $(BUILD_TREE) clean

	$(MAKE) -C $(BUILD_TREE) VERSION=$(VERSION) lnps	# Use PAM

	LD_LIBRARY_PATH=$(BUILD_TREE)/c-client
	for i in "chkmail" "dmail" "icat" "ifrom" "imapcopy" "imapxfer" \
	"mbxcopy" "mbxcreat" "mbxcvt" "mlock" "tmail" ; do \
		$(MAKE) -C $(BUILD_TREE)/src/$$i ; \
	done
	touch $(STAMP_DIR)/build-stamp

clean:
	dh_testdir debian/control.in
	-rm -rf $(SOURCE_DIR) $(STAMP_DIR)
	-rm -f c-client.a
	-rm -rf debian/uw-imapd debian/ipop debian/libc-client$(VERSION) debian/libc-client$(VERSION)-dev debian/mlock debian/files* core debian/substvars
	sed -e s/__DEBIANVER__/$(DEBVERSION)/g -e s/__VER__/$(VERSION)/g \
		<debian/control.in >debian/control
	dh_clean

binary-indep: build
	dh_testdir
# There are no architecture-independent files to be uploaded
# generated by this package.  If there were any they would be
# made here.

binary-arch: build
	dh_testdir
	sed -e s/__DEBIANVER__/$(DEBVERSION)/g -e s/__VER__/$(VERSION)/g \
		<debian/control.in >debian/control
	dh_clean
	dh_installdirs
	ln -sf $(CURDIR)/debian $(BUILD_TREE)/debian
	(cd $(BUILD_TREE) && dh_installdocs)
	dh_installchangelogs
	dh_installpam
	(cd debian/ipopd/etc/pam.d/ && mv ipopd pop)
	(cd debian/uw-imapd/etc/pam.d/ && mv uw-imapd imap)
	install $(BUILD_TREE)/imapd/imapd -o root -g mail -m 2755 debian/uw-imapd/usr/sbin/imapd
	for i in "chkmail" "dmail" "icat" "ifrom" "imapcopy" "imapxfer" \
	"mbxcopy" "mbxcreat" "mbxcvt" "tmail" ; do \
		install $(BUILD_TREE)/src/$$i/$$i -o root -g root -m 0755 \
		 debian/uw-imapd/usr/bin/$$i ; \
	done
	(cd debian/uw-imapd/usr/bin && ln -s mbxcopy mbxmove)
	install debian/uw-imapd.logcheck -o root -g root -m 0644 debian/uw-imapd/etc/logcheck/ignore.d.server/uw-imapd
	install debian/uw-imapd.overrides -o root -g root -m 0644 debian/uw-imapd/usr/share/lintian/overrides/uw-imapd
	install $(BUILD_TREE)/ipopd/ipop2d -o root -g mail -m 2755 debian/ipopd/usr/sbin/ipop2d
	install $(BUILD_TREE)/ipopd/ipop3d -o root -g mail -m 2755 debian/ipopd/usr/sbin/ipop3d
	install debian/ipopd.logcheck -o root -g root -m 0644 debian/ipopd/etc/logcheck/ignore.d.server/ipopd
	install debian/ipopd.overrides -o root -g root -m 0644 debian/ipopd/usr/share/lintian/overrides/ipopd
	install $(BUILD_TREE)/c-client/libc-client.so -o root -g root -m 0644 debian/libc-client$(VERSION)/usr/lib/libc-client.so.$(VERSION)
	install $(BUILD_TREE)/c-client/*.h -o root -g root -m 0644 debian/libc-client$(VERSION)-dev/usr/include/c-client
	install $(BUILD_TREE)/c-client/linkage.c -o root -g root -m 0644 debian/libc-client$(VERSION)-dev/usr/include/c-client
	install c-client.a -o root -g root -m 0644 debian/libc-client$(VERSION)-dev/usr/lib
	(cd debian/libc-client$(VERSION)-dev/usr/lib && ln -s c-client.a libc-client.a)
	install $(BUILD_TREE)/mtest/mtest -o root -g root -m 0755 debian/libc-client$(VERSION)-dev/usr/bin/mtest
	ln -s libc-client.so.$(VERSION) debian/libc-client$(VERSION)-dev/usr/lib/libc-client.so
	install $(BUILD_TREE)/src/mlock/mlock -o root -g mail -m 2755 debian/mlock/usr/bin/mlock
	install debian/mlock.overrides -o root -g root -m 0644 debian/mlock/usr/share/lintian/overrides/mlock
	dh_undocumented
	dh_installmanpages --package=uw-imapd ipopd.8c debian/mlock.1
	dh_installmanpages --package=ipopd imapd.8c chkmail.1 dmail.1 icat.1 ifrom.1 imapcopy.1 imapxfer.1 mbxcopy.1 mbxcreat.1 mbxcvt.1 tmail.1 debian/mlock.1
	dh_installmanpages --package=mlock imapd.8c ipopd.8c chkmail.1 dmail.1 icat.1 ifrom.1 imapcopy.1 imapxfer.1 mbxcopy.1 mbxcreat.1 mbxcvt.1 tmail.1
	(cd debian/uw-imapd/usr/share/man/man1 && ln -s mbxcopy.1.gz mbxmove.1.gz)
	(cd debian/uw-imapd/usr/share/man/man1 && ln -s imapcopy.1.gz imapmove.1.gz)
	(cd debian/ipopd/usr/share/man/man8 && ln -s ipopd.8c.gz ipop2d.8c.gz)
	(cd debian/ipopd/usr/share/man/man8 && ln -s ipopd.8c.gz ipop3d.8c.gz)
	dh_strip
	dh_compress
	dh_fixperms --exclude=/usr/sbin/imapd --exclude=/usr/sbin/ipop2d --exclude=/usr/sbin/ipop3d --exclude=/usr/bin/mlock
	dh_installdeb
	dh_makeshlibs -plibc-client$(VERSION)
	dh_shlibdeps -l $(CURDIR)/debian/libc-client$(VERSION)/usr/lib
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch

.PHONY: build clean binary binary-arch binary-indep
